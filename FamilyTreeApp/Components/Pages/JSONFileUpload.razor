@inject TreeDataService TreeData

@page "/jsonFileUpload"
@using System.Text.Json
@using System.Text
@rendermode InteractiveServer

<h1>Upload your JSON document:</h1>

<InputFile OnChange="HandleFileSelected" accept=".json" />

@if (!string.IsNullOrEmpty(_fileContent))
{
    <br><p><strong>File content:</strong></p>
   
    <div>        
        @if(_showInput) 
        {
            <div class="input-container" id="inputContainer">
                <textarea @bind="_fileContent" style="font-family: monospace;">@_fileContent</textarea>
            </div><br>
        }
        <div class="horizontal-container">
            <button class="toggle-btn" @onclick="HandleToggleButtonClick">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    viewBox="0 0 24 24">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>
            @if(_showInput) 
            {           
                <button class="toggle-btn" @onclick="UpdateFamilyTree">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" 
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                        viewBox="0 0 24 24">
                        <path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7z"/>
                        <polyline points="17 3 17 8 7 8"/>
                        <rect x="7" y="13" width="6" height="5"/>
                    </svg>
                </button>
            }
            @if (!string.IsNullOrEmpty(_downloadUrl))
            {
                <a href="@_downloadUrl"
                    download="FamilyTree_Modified.json"
                    class="download-button">
                    📥 Download
                </a>
            }
        </div>
    </div>
}

@code {
    private string? _fileContent;
    private string? _downloadUrl;
    private bool _showInput = true;
    private int _maxAllowedFileSize = 10 * 1024 * 1024;

    private void HandleToggleButtonClick() 
    {
        _showInput = !_showInput;
    }

    private void UpdateFamilyTree()
    {
        if (string.IsNullOrEmpty(_fileContent)) return;

        SaveJSONDocument();

        try
        {
            FamilyTreeNode? rootNode = JsonSerializer.Deserialize<FamilyTreeNode>(
                _fileContent,
                new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    WriteIndented = true
                }
            );

            if (rootNode != null) 
            {
                TreeData.SetRootNode(rootNode);
                Console.WriteLine("Changes have been saved.");
                return;
            }

            Console.WriteLine("RootNode could not be updated.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JSON deserialization failed: {ex.Message}");
            TreeData.RootNode = null;
        }
    }

    private void SaveJSONDocument()
    {
        if (string.IsNullOrEmpty(_fileContent)) return;

        byte[] bytes = Encoding.UTF8.GetBytes(_fileContent);
        string base64 = Convert.ToBase64String(bytes);
        _downloadUrl = $"data:application/json;base64,{base64}";
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        IBrowserFile file = e.File;

        if (file == null || !file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
        {
            _fileContent = "Invalid file type. Please upload a .json file.";
            return;
        }

        using Stream stream = file.OpenReadStream(maxAllowedSize: _maxAllowedFileSize); // 10 MB
        using StreamReader reader = new StreamReader(stream);
        _fileContent = await reader.ReadToEndAsync();
        
        TreeData.UploadedJson = _fileContent;
        
        try
        {
            FamilyTreeNode? rootNode = JsonSerializer.Deserialize<FamilyTreeNode>(
                TreeData.UploadedJson,
                new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    WriteIndented = true
                }
            );

            if (rootNode != null) 
            {
                TreeData.SetRootNode(rootNode);
                Console.WriteLine("Read the json file.");
                return;
            }

            Console.WriteLine("Root node could not be instanciated.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JSON deserialization failed: {ex.Message}");
            TreeData.RootNode = null;
        }        
    }
}
